<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Demo - List</title>
	
	<!-- All stylesheets and scripts injected into each page -->
	<link rel="stylesheet" href="">
	<link rel="stylesheet" href="/lib/css/bootstrap.min.css">
	<link rel="stylesheet" href="/lib/css/fontawesome.min.css">
	<link rel="stylesheet" href="/lib/css/roboto.min.css">
	<link rel="stylesheet" href="/lib/css/toastr.min.css">
	<link rel="stylesheet" href="/lib/css/vue-autocomplete.min.css">
	<link rel="stylesheet" href="/lib/css/vue-multiselect.min.css">
	<link rel="stylesheet" href="/lib/css/vue-tour.min.css">
	<link rel="stylesheet" href="/css/integrity-table.css">
	<link rel="stylesheet" href="/css/integrity-navbar.css">
	<link rel="stylesheet" href="/css/integrity-drawer.css">
	<link rel="stylesheet" href="/css/overrides.css">
	<script src="/lib/js/jquery.min.js"></script>
	<script src="/lib/js/vue.js"></script>
	<script src="/lib/js/lodash.min.js"></script>
	<script src="/lib/js/moment.min.js"></script>
	<script src="/lib/js/toastr.min.js"></script>
	<script src="/lib/js/chart.min.js"></script>
	<script src="/lib/js/bootstrap.min.js"></script>
	<script src="/lib/js/vue-multiselect.min.js"></script>
	<script src="/lib/js/vue-autocomplete.min.js"></script>
	<script src="/lib/js/vue-tour.min.js"></script>
	<script src="/js/integrity.js"></script>
	<script src="/js/integrity-table.js"></script>
	<script src="/js/integrity-navbar.js"></script>
	<script src="/js/integrity-drawer.js"></script>
	<script src="/lib/js/paho-mqtt.js"></script>		<!-- added for server mqtt comms -->


</head>
<style>

/* This is the last style tag linked into every page */
html {
	padding: 0;
}
html, body, #app {
	height: 100%;
	overflow: hidden;
}
.app-container {
	height: calc(100% - 40px);
	padding: 10px;
}

[v-cloak] {visibility: hidden;}


</style>
<script type="text/x-template" id="integrity-drawer">
<div class="int-drawer-background" @click.self="backgroundClicked()" v-if="show">
	<div class="int-drawer">
		<div class="btn btn-danger float-right" @click="backgroundClicked()"><i class="fas fa-window-close"></i></div>
		<slot>Hi</slot>
	</div>
</div>
</script>
<script type="text/x-template" id="integrity-navbar">
<nav id="integrity-main">Integrity<span>OS</span>
	<span class="float-right welcome-user">
		<span id="user">{{fullname}}</span> : <span id="role">{{role}}</span>
	</span>
</nav>
</script>
<script type="text/x-template" id="integrity-table">
<div id="int-table-wrapper">
<div class="int-table-flex int-table-align">
	<div class="col-3">
		<h2>{{name}}</h2>
	</div>
	<div class="col-6">
		<div v-show="filterToggle" class="int-table-flex">
			<div class="col-5">
				<select class="form-control" v-model="selectedFilterColumn">
					<option value='nocolumn'>Select Column...</option>
					<option v-for='(item, index) in columns' :value="item">{{item}} {{activeFilterCount(item)}}</option>
				</select>
			</div>
			<div class="col-5">
				<div v-if="selectedFilterColumn != 'nocolumn'" class="int-table-lift">
					<vue-multiselect :options="filterOptions[selectedFilterColumn]" v-model="filters[selectedFilterColumn]" :multiple="true" :close-on-select="false" :clear-on-select="false" :limit="0" :limit-text="limitText" placeholder="" @close=""></vue-multiselect>
				</div>
			</div>
			<div class="col-1"></div>
			<div class="col-1 btn btn-warning" @click="resetFilters"><i class="fas fa-recycle"></i></div>
		</div>
	</div>
	<div class="int-table-flex col-3">
		<div :class="'col-2 btn btn-' + (filterToggle ? 'info' : 'primary')" @click="filterToggle = !filterToggle"><i class="fas fa-filter"></i></div>
		<div class="col-1"></div>
		<input type="text" v-model="search" class="form-control col-8" placeholder="search">
	</div>
</div>
<div id="int-table-container">
	<div class="int-table">
		<div class="int-table-header">
			<div class="int-table-row">
				<div v-for="(column, index) in columns" @click="setOrder(index + 1)" :class="colWidthClass(fields[index])">
					<span>{{column}} <i :class="sortClass()" v-if="order == index + 1"></i></span>
				</div>
			</div>
		</div>
		<div class="int-table-body">
			<div class="int-table-row" v-for="(item, index) in filtered(mainCollection)" v-if="pagination(index)" @click="select(item)">
				<div v-for="(value, field) in item" :class="cellStyleClass(item, field) + ' ' + colWidthClass(field)" >
					<slot :item="item" :name="field">{{value}}</slot>
				</div>
			</div>
		</div>
	</div>
</div>
<div class="float-right">
	<div :class="previousButtonClass()" @click="previousButtonClick()">Previous</div>
	<span id="int-table-paging-text">{{pagingText}}</span>
	<div :class="nextButtonClass()" @click="nextButtonClick()">Next</div>
</div>
<div class="int-table-record-count">{{summaryText}}</div>
</div>
</script>

	<div id="app" v-cloak>
		
	<!-- This is injected as the first child to #app in each page -->
	<integrity-navbar></integrity-navbar>

		<div class="app-container">
			<integrity-table  v-if="hasList" :name="pageName" :collection="main_collection" :columns="columns" @select="onSelect">
			</integrity-table>
			<div v-else class="d-flex justify-content-center">
				<div class="container-fluid">
					<div class="row justify-content-center">
						<div class="spinner-border" role="status">
							<span class="sr-only">Loading...</span>
						</div>
					</div>
					<div class="row justify-content-center">
						<strong>{{ update_msg }}</strong>
					</div>
				</div>
			</div>
		</div>
	</div>

<style scoped>
.custom-loading-text {
    transform: rotate(-90deg);
    position: absolute;
    top: -1.5rem;
    left: -1rem;
    white-space: nowrap;
}
</style>

<script>
	
	/* This is injected right before every pages view model is initialized */
	Vue.mixin({
		// Global mixin standard components
		components: {
			"vue-autocomplete": Autocomplete,
			"vue-multiselect": window.VueMultiselect.default,
			"vue-tour": window["vue-tour"].default,
		},
		// Provide sensible callback defaults in the event they are not defined in the page module
		methods: {
			// Default limit text function for multiselect
			limitText(count){
				return "(" + count + ") selected"
			},
			// Default drawer closer, assumes presence of drawerShow data var
			closeDrawer(){
				this.drawerShow = false
			},
			// No style class if one not defined
			cellStyleClass(item, field){
				return ""
			},
			// Standard col width if one not defined
			colWidthClass(field){
				return "int-table-width-1"
			}
		}
	})
	// This simulates a user having securely logged in
	ilib.setCookie("fullname", "Demo User")
	ilib.setCookie("role", "Admin")


	var host = "10.0.15.70"
	var ws_port = 8201
	var port = 1891

	var baseUrl = "http://" + host + ":" + port + "/flows-1/api/kitting";

	const vm = new Vue({
    el: "#app",
    data: {
        update_msg: 'Waiting for server...',
        update_value: 0,
        pageName: 'Kitting Inventory',
		columns: ["Kit", "In-stock", "Required", " Status"],
		main_collection: [],
		kit_name: '',
    },
    computed: {
		hasList: function() {
            return this.main_collection.length > 0;
	    },

    },// --- End of computed --- //
    methods: {
					// This allows a page to set integrity-table cell styles by field and value conditionally
			cellStyleClass(item, field){
				if(field == "column5" && item.column5 > '2020-01-01'){
					return 'int-table-cell-pink'
				}
				return ""
			},
			// This allows a page to set integrity-table column widths and visibility
			colWidthClass(field){
				if(field == "column1"){
					return 'int-table-width-5'
				} else if (field == "column10") {
					return 'int-table-width-3'
				} else if (["column3", "column7", "column8", "column9"].indexOf(field) > -1) {
					return 'int-table-width-none'
				}
				return "int-table-width-1"
			},
			successClicked(){
				toastr.success("Success")
			},
			primaryClicked(){
				toastr.info("Primary")
			},
			openDrawer(){
				this.drawerShow = true
			},
			async retrieveKits(){
				Integrity.get(baseUrl +'/kits')
				.done(function(response){
					if (response === null)
						vm.main_collection = [{kit: "No kits found", 'in-stock':0, total:0, percent:"0%"}]
					else
						vm.main_collection = response
				})
				.fail(function(err) {
					vm.main_collection = [{kit: "Err", 'in-stock':-1, total:-1, percent:"Err"}]
					console.log(err);
				});

			},
        	async onSelect(item) {
            	try{
					this.kit_name = item.kit
					var url = window.location.pathname;
					var path = url.substring(0, url.lastIndexOf("/"))
					window.location.href = path + `/detail.html?name=${this.kit_name}`;

				} catch(err) {
					console.log(err);
				}
      	  	},
        
    }, // --- End of methods --- //
    watch: {
    },  // --- End of watch --- //
    // Available hooks: init,mounted,created,updated,destroyed
    created: function(){
        this.retrieveKits()
    },
    mounted: function(){

		$.ajaxSetup({
		headers: {
			"Content-type": "application/json"
		},
		timeout: 5000 //Time in milliseconds
		});

		var MQTT_CLIENT_ID = "iot_web_"+Math.floor((1 + Math.random()) * 0x10000000000).toString(16);
		var socket = new Paho.Client(host, ws_port, MQTT_CLIENT_ID)

        var vueApp = this
        var reconnectTimeout = 2000
        MQTTConnect()

        function MQTTConnect() {
            var options = {
                timeout: 3,
                onSuccess: onConnect,
                onFailure: onFailure,
                
            };
            socket.onMessageArrived = onMessageArrived
            socket.connect(options)
        }

        function onFailure(message) {
			console.log("Connection Attempt to Host Failed");
			setTimeout(MQTTConnect, reconnectTimeout);
        }
        function onConnect() {
            socket.subscribe("message");
            socket.subscribe("value");
            console.log("MQTT Connected");
        }
        function onMessageArrived(msg) {
            console.log(msg.destinationName + " : " + msg.payloadString)
            if (msg.destinationName === "message")
                vueApp.update_msg = msg.payloadString
            else if (msg.destinationName === "value")
                vueApp.update_value = msg.payloadString
            else if (msg.destinationName === "kit")
                vueApp.kit_name = msg.payloadString
        }

    }, // --- End of hooks --- //
}) // --- End of vm --- //
</script>
</body>
</html>	
